<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ë‘ ê¸¸ë“œ - ì‚¬ì§„ ê²Œì‹œíŒ</title>

  <!-- Pretendard -->
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.css" />

  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --line:rgba(0,0,0,.08);
      --text:#1f1f24;
      --sub:rgba(31,31,36,.70);
      --brand:#f48fb1;
      --brand2:#b39ddb;
      --shadow: 0 14px 38px rgba(0,0,0,.07);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Pretendard Variable, Pretendard, system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      background:
        radial-gradient(1100px 520px at 10% 0%, rgba(244,143,177,.23), transparent 60%),
        radial-gradient(1000px 520px at 90% 10%, rgba(179,157,219,.20), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{max-width:1120px;margin:0 auto;padding:30px 18px 10px}
    h1{margin:0;font-size:22px;letter-spacing:-0.2px}
    p{margin:10px 0 0;color:var(--sub)}
    main{max-width:1120px;margin:0 auto;padding:18px 18px 36px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.98));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .notice{font-size:13px;color:var(--sub)}
    .danger{color:#c62828}
    .muted{color:var(--sub)}
    hr{border:none;border-top:1px solid var(--line);margin:16px 0}

    .btn{
      appearance:none;
      border:1px solid rgba(244,143,177,.35);
      background:rgba(244,143,177,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, color .15s ease;
      user-select:none;
    }
    .btn:hover{
      background:rgba(244,143,177,.20);
      border-color: rgba(244,143,177,.55);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      border-color:rgba(0,0,0,.12);
      background:rgba(255,255,255,.72);
    }
    .btn.secondary:hover{
      background:rgba(244,143,177,.14);
      border-color: rgba(244,143,177,.45);
      color: var(--brand);
    }

    /* ë©”ì¸ìœ¼ë¡œ: ë°‘ì¤„ ì œê±° + í˜¸ë²„ í•‘í¬ */
    a.btnlink{ text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    a.btnlink:hover{ color: var(--brand); }

    .field{display:grid;gap:6px;margin-top:10px}
    label{font-size:12px;color:var(--sub)}
    input, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.88);
      font:inherit;
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    textarea{ resize: vertical; min-height: 40px; }
    input:focus, textarea:focus{
      border-color: rgba(244,143,177,.65);
      box-shadow: 0 0 0 4px rgba(244,143,177,.14);
    }

    .thumb{
      width:100%;
      aspect-ratio:1/1;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
      background:linear-gradient(135deg, rgba(244,143,177,.12), rgba(179,157,219,.10));
      cursor: zoom-in;
      position: relative;
    }
    .thumb::after{
      content:"í´ë¦­í•´ì„œ í¬ê²Œ ë³´ê¸°";
      position:absolute;
      left:10px; bottom:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.08);
      color: rgba(31,31,36,.72);
      opacity:0;
      transform: translateY(6px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events:none;
    }
    .thumb:hover::after{ opacity:1; transform: translateY(0); }

    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{display:flex;justify-content:space-between;gap:10px;margin-top:10px;color:var(--sub);font-size:12px}
    .title{margin:10px 0 0;font-weight:900;letter-spacing:-0.2px}
    .desc{margin:6px 0 0; font-size:13px; color: var(--sub); line-height:1.35}

    /* ì—…ë¡œë“œ í¼ ë ˆì´ì•„ì›ƒ */
    .form-grid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr 1.4fr 0.9fr 1.2fr;
      gap:12px;
      margin-top:12px;
      align-items:end;
    }
    @media (max-width:980px){
      .form-grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width:560px){
      .form-grid{ grid-template-columns: 1fr; }
    }

    /* ëª¨ë‹¬ */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(15, 12, 18, .55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width: min(920px, 100%);
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(255,255,255,.28);
      border-radius: 22px;
      box-shadow: 0 30px 70px rgba(0,0,0,.25);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.3fr 1fr;
    }
    @media (max-width:860px){
      .modal{ grid-template-columns: 1fr; }
    }
    .modal-media{
      background: linear-gradient(135deg, rgba(244,143,177,.12), rgba(179,157,219,.10));
      display:flex; align-items:center; justify-content:center;
      padding: 14px;
    }
    .modal-media img{
      max-width: 100%;
      max-height: 72vh;
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
      object-fit: contain;
      background: white;
    }
    .modal-side{
      padding: 18px 18px 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .modal-title{ font-weight: 900; font-size: 18px; letter-spacing: -0.2px; margin: 0; }
    .modal-meta{ font-size: 13px; color: var(--sub); display:flex; gap:10px; flex-wrap:wrap; }
    .modal-desc{ font-size: 14px; color: rgba(31,31,36,.78); line-height: 1.45; margin: 0; white-space: pre-wrap; }
    .modal-actions{ margin-top:auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .xbtn{
      position:absolute;
      top: 12px; right: 12px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.75);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:800;
      transition: background .15s ease, color .15s ease, border-color .15s ease;
    }
    .xbtn:hover{ background: rgba(244,143,177,.16); border-color: rgba(244,143,177,.40); color: var(--brand); }
    .modal-wrap{ position:relative; }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div>
        <h1>ğŸ“· ë°©ë‘ ê¸¸ë“œ ì‚¬ì§„ ê²Œì‹œíŒ</h1>
        <p>ë¡œê·¸ì¸ ì—†ì´ ì—…ë¡œë“œ ê°€ëŠ¥ Â· ìš´ì˜ì§„ì€ ìš´ì˜ì§„ í˜ì´ì§€ì—ì„œë§Œ ì‚­ì œ ê°€ëŠ¥</p>
      </div>
      <div class="row">
        <a class="btn secondary btnlink" href="/">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
        <button class="btn" id="refreshBtn" type="button">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:900;">ì‚¬ì§„ ì˜¬ë¦¬ê¸°</div>
          <div class="notice">â€» ìš•ì„¤/í˜ì˜¤/ê°œì¸ì •ë³´ í¬í•¨ ì´ë¯¸ì§€ëŠ” ìš´ì˜ì§„ì´ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.</div>
        </div>
        <div id="status" class="notice"></div>
      </div>

      <!-- âœ… ì…ë ¥ ìˆœì„œ: ì œëª© / ë‹‰ë„¤ì„ / ì„¤ëª… / ë‚ ì§œ / ì‚¬ì§„íŒŒì¼ -->
      <div class="form-grid">
        <div class="field">
          <label>ì œëª©</label>
          <input id="title" placeholder="ì˜ˆ: ëŒ€ì¥ì„ ê¸°ë‹¤ë¦¬ëŠ” ì½©íŒ¥ë‹¨" maxlength="80" />
        </div>
        <div class="field">
          <label>ë‹‰ë„¤ì„</label>
          <input id="nickname" placeholder="ì˜ˆ: ë„ˆí¬ì§‘ë§‰ë‚´" maxlength="30" />
        </div>
        <div class="field">
          <label>ì„¤ëª…(ì„ íƒ)</label>
          <textarea id="caption" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ë ˆì´ë“œ ì²« í´ë¦¬ì–´!" maxlength="400"></textarea>
        </div>
        <div class="field">
          <label>ë‚ ì§œ</label>
          <input id="postDate" type="date" />
        </div>
        <div class="field">
          <label>ì‚¬ì§„ íŒŒì¼</label>
          <input id="file" type="file" accept="image/*" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn" id="uploadBtn" type="button">ì—…ë¡œë“œ</button>
      </div>

      <hr>

      <div class="row" style="justify-content:space-between">
        <div style="font-weight:900;">ìµœê·¼ ì‚¬ì§„</div>
        <div class="notice">ì´ <span id="count">0</span>ê°œ</div>
      </div>
      <div id="list" class="grid" style="margin-top:12px"></div>

      <!-- âœ… ìš´ì˜ì§„ UIëŠ” "ìš´ì˜ì§„ í˜ì´ì§€"ì—ì„œë§Œ ë³´ì´ë„ë¡ -->
      <div id="adminPanel" style="display:none;margin-top:16px" class="notice">
        <details open>
          <summary style="cursor:pointer;font-weight:900">ìš´ì˜ì§„ ì‚­ì œ(ê´€ë¦¬ì)</summary>
          <div style="margin-top:10px" class="field">
            <label>ê´€ë¦¬ì í† í° (ìš´ì˜ì§„ë§Œ ì•Œê³  ìˆëŠ” ê°’)</label>
            <input id="adminToken" placeholder="ADMIN_TOKEN" />
            <div class="notice">ìš´ì˜ì§„ í˜ì´ì§€ì—ì„œë§Œ ì‚­ì œ ë²„íŠ¼ì´ ë³´ì—¬ìš”. í† í°ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì§€ ì•Šì•„ìš”.</div>
          </div>
        </details>
      </div>
    </section>
  </main>

  <!-- âœ… ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal-wrap">
      <button class="xbtn" id="modalCloseBtn" type="button">âœ•</button>
      <div class="modal" role="dialog" aria-modal="true" aria-label="ì‚¬ì§„ í¬ê²Œ ë³´ê¸°">
        <div class="modal-media"><img id="modalImg" alt=""></div>
        <div class="modal-side">
          <h2 class="modal-title" id="modalTitle"></h2>
          <div class="modal-meta" id="modalMeta"></div>
          <p class="modal-desc" id="modalDesc"></p>
          <div class="modal-actions">
            <button class="btn secondary" type="button" id="modalCopyBtn">ë§í¬ ë³µì‚¬</button>
            <button class="btn secondary" type="button" id="modalOpenBtn">ì›ë³¸ ë³´ê¸°</button>
            <button class="btn secondary" type="button" id="modalDeleteBtn" style="display:none">ì‚­ì œ(ìš´ì˜ì§„)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- /supabase_config.js : SUPABASE_URL / SUPABASE_ANON_KEY ê°€ ìˆì–´ì•¼ í•¨ -->
  <script src="/supabase_config.js"></script>

  <script>
    const BUCKET = "bangrang-photos";
    const TABLE  = "photo_posts";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");

    function setStatus(msg, isError=false){
      statusEl.textContent = msg || "";
      statusEl.className = "notice" + (isError ? " danger" : "");
    }
    function fmt(dt){
      try{
        const d = new Date(dt);
        return d.toLocaleString("ko-KR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch(e){ return ""; }
    }
    function fmtDateOnly(ymd){
      if(!ymd) return "";
      try{
        // ymd = 'YYYY-MM-DD'
        const [y,m,d] = String(ymd).split("-").map(v=>parseInt(v,10));
        if(!y || !m || !d) return String(ymd);
        return `${y}.${String(m).padStart(2,"0")}.${String(d).padStart(2,"0")}`;
      }catch(e){ return String(ymd); }
    }
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    // âœ… ìš´ì˜ì§„ í˜ì´ì§€ íŒë³„: URLì— ?admin=1 ì´ê±°ë‚˜, ê²½ë¡œì— /admin/ í¬í•¨
    const qs = new URLSearchParams(location.search);
    const IS_ADMIN_PAGE = (qs.get("admin") === "1") || location.pathname.includes("/admin/") || location.pathname.endsWith("/admin") || location.pathname.includes("admin");

    if (IS_ADMIN_PAGE) {
      $("adminPanel").style.display = "block";
    }

    if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
      setStatus("ì„¤ì • ëˆ„ë½: supabase_config.jsì— SUPABASE_URL / SUPABASE_ANON_KEYë¥¼ ë„£ì–´ì¤˜!", true);
      console.error("Missing SUPABASE config", window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    }

    const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    function getStoragePathFromRow(row){
      return (
        row.image_path ||
        row.path ||
        row.imagePath ||
        row.image ||
        row.file_path ||
        ""
      );
    }

    function getTitleFromRow(row){
      return row.title || row.post_title || row.name || row.caption_title || row.caption || "ì‚¬ì§„";
    }

    function getDescFromRow(row){
      // ê¸°ì¡´ captionì„ ì„¤ëª…ìœ¼ë¡œ ë³´ì´ë˜, titleì´ ë”°ë¡œ ìˆìœ¼ë©´ captionì„ descë¡œ ì‚¬ìš©
      return row.description || row.desc || row.caption || "";
    }

    function getPostDateFromRow(row){
      return row.post_date || row.date || row.taken_at || row.event_date || row.photo_date || "";
    }

    function getDisplayDate(row){
      const postDate = getPostDateFromRow(row);
      return postDate ? fmtDateOnly(postDate) : fmt(row.created_at);
    }

    // âœ… ëª¨ë‹¬ ìƒíƒœ
    let currentModal = { id:null, path:null, url:null, title:"", nickname:"", desc:"", dateText:"" };

    function openModal(payload){
      currentModal = payload;
      $("modalImg").src = payload.url || "";
      $("modalTitle").textContent = payload.title || "ì‚¬ì§„";

      const metaBits = [];
      if(payload.nickname) metaBits.push(`ğŸ‘¤ ${payload.nickname}`);
      if(payload.dateText) metaBits.push(`ğŸ“… ${payload.dateText}`);
      $("modalMeta").textContent = metaBits.join(" Â· ");

      $("modalDesc").textContent = payload.desc || "";

      $("modalBackdrop").style.display = "flex";
      $("modalBackdrop").setAttribute("aria-hidden", "false");

      // ìš´ì˜ì§„ì—ì„œë§Œ ì‚­ì œ ë²„íŠ¼ ë…¸ì¶œ
      $("modalDeleteBtn").style.display = IS_ADMIN_PAGE ? "inline-flex" : "none";
    }

    function closeModal(){
      $("modalBackdrop").style.display = "none";
      $("modalBackdrop").setAttribute("aria-hidden", "true");
      $("modalImg").src = "";
    }

    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeModal();
    });
    $("modalCloseBtn").addEventListener("click", closeModal);
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeModal();
    });

    $("modalCopyBtn").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(currentModal.url || "");
        setStatus("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´!");
      }catch{
        setStatus("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ)", true);
      }
    });
    $("modalOpenBtn").addEventListener("click", ()=>{
      if(currentModal.url) window.open(currentModal.url, "_blank", "noopener");
    });

    async function listPhotos(){
      setStatus("");
      $("list").innerHTML = "";

      const { data, error } = await sb
        .from(TABLE)
        .select("*")
        .order("created_at", { ascending:false })
        .limit(30);

      if(error){
        setStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message, true);
        console.error(error);
        return;
      }

      $("count").textContent = data.length;

      if(data.length === 0){
        $("list").innerHTML = '<div class="notice">ì•„ì§ ì‚¬ì§„ì´ ì—†ì–´ìš”! ì²« ì—…ë¡œë“œ í•´ì¤˜ìš” ğŸ’–</div>';
        return;
      }

      for(const row of data){
        const storagePath = getStoragePathFromRow(row);
        const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(storagePath || "");
        const imgUrl = pub.publicUrl;

        const title = getTitleFromRow(row);
        const desc  = getDescFromRow(row);
        const nickname = row.nickname || "ìµëª…";
        const dateText = getDisplayDate(row);

        const card = document.createElement("div");
        card.className = "card";

        // ìš´ì˜ì§„ ì‚­ì œ ë²„íŠ¼ì€ ìš´ì˜ì§„ í˜ì´ì§€ì—ì„œë§Œ ë Œë”
        const adminDeleteBtnHtml = IS_ADMIN_PAGE
          ? `<button class="btn secondary" type="button" data-action="delete" data-id="${row.id}" data-path="${storagePath}">ì‚­ì œ(ìš´ì˜ì§„)</button>`
          : ``;

        card.innerHTML = `
          <div class="thumb" role="button" tabindex="0"
               data-action="view"
               data-id="${row.id}"
               data-path="${storagePath}"
               data-url="${imgUrl}"
               data-title="${escapeHtml(title)}"
               data-nickname="${escapeHtml(nickname)}"
               data-desc="${escapeHtml(desc)}"
               data-date="${escapeHtml(dateText)}">
            <img alt="" src="${imgUrl}">
          </div>
          <div class="meta"><span>${escapeHtml(nickname)}</span><span>${escapeHtml(dateText)}</span></div>
          <div class="title">${escapeHtml(title)}</div>
          ${desc ? `<div class="desc">${escapeHtml(desc)}</div>` : ``}
          <div class="row" style="justify-content:flex-end;margin-top:12px">
            <button class="btn secondary" type="button" data-action="copy" data-url="${imgUrl}">ë§í¬ ë³µì‚¬</button>
            <button class="btn secondary" type="button" data-action="open" data-url="${imgUrl}">ì›ë³¸ ë³´ê¸°</button>
            ${adminDeleteBtnHtml}
          </div>
        `;
        $("list").appendChild(card);
      }
    }

    // âœ… DBì— ë‚ ì§œ ì»¬ëŸ¼ì´ ì—†ì„ ìˆ˜ë„ ìˆì–´ì„œ: (1) date í¬í•¨ insert ì‹œë„ â†’ (2) ì‹¤íŒ¨í•˜ë©´ date ì—†ì´ ì¬ì‹œë„
    async function insertPostSafe(payload){
      // 1ì°¨ ì‹œë„: title/description/post_date í¬í•¨
      const { error: err1 } = await sb.from(TABLE).insert([payload]);
      if(!err1) return { ok:true };

      // "column does not exist" / schema cache ë¬¸ì œ ë“±ì¼ ë•Œ: date/title/description ì œê±° í›„ ì¬ì‹œë„
      const msg = String(err1.message || "");
      const looksLikeColumnIssue = msg.includes("column") || msg.includes("schema") || msg.includes("not found");

      if(looksLikeColumnIssue){
        const fallback = {
          nickname: payload.nickname,
          caption: payload.description ? `[${payload.title}] ${payload.description}` : (payload.title || "ì‚¬ì§„"),
          image_path: payload.image_path,
        };
        const { error: err2 } = await sb.from(TABLE).insert([fallback]);
        if(!err2){
          return { ok:true, fallback:true, warn:"DBì— title/description/post_date ì»¬ëŸ¼ì´ ì—†ì–´ì„œ captionì— í•©ì³ì„œ ì €ì¥í–ˆì–´ìš”." };
        }
        return { ok:false, error: err2 };
      }

      return { ok:false, error: err1 };
    }

    async function upload(){
      const title = $("title").value.trim() || "ì‚¬ì§„";
      const nickname = $("nickname").value.trim() || "ìµëª…";
      const description = $("caption").value.trim() || "";
      const post_date = $("postDate").value || ""; // YYYY-MM-DD
      const file = $("file").files?.[0];

      if(!file){ setStatus("ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•´ì¤˜!", true); return; }
      if(file.size > 8 * 1024 * 1024){ setStatus("íŒŒì¼ì´ ë„ˆë¬´ ì»¤ìš”. 8MB ì´í•˜ë¡œ ì˜¬ë ¤ì¤˜!", true); return; }

      setStatus("ì—…ë¡œë“œ ì¤‘...");

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const safeExt = ["jpg","jpeg","png","webp","gif"].includes(ext) ? ext : "jpg";
      const path = `${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;

      const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, {
        cacheControl: "3600",
        upsert: false,
        contentType: file.type || "image/jpeg",
      });
      if(upErr){ setStatus("ì—…ë¡œë“œ ì‹¤íŒ¨: " + upErr.message, true); return; }

      const payload = {
        title,
        nickname,
        description,         // ì»¬ëŸ¼ì´ ì—†ì„ ìˆ˜ ìˆìŒ (safe insertì—ì„œ ì²˜ë¦¬)
        post_date,           // ì»¬ëŸ¼ì´ ì—†ì„ ìˆ˜ ìˆìŒ (safe insertì—ì„œ ì²˜ë¦¬)
        image_path: path
      };

      const ins = await insertPostSafe(payload);
      if(!ins.ok){
        await sb.storage.from(BUCKET).remove([path]);
        setStatus("ì €ì¥ ì‹¤íŒ¨: " + (ins.error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), true);
        console.error(ins.error);
        return;
      }

      if(ins.fallback){
        setStatus("ì—…ë¡œë“œ ì™„ë£Œ! ğŸ’– (ì£¼ì˜: ë‚ ì§œ/ì œëª© ì»¬ëŸ¼ì´ ì—†ì–´ì„œ ì„¤ëª…ì— í•©ì³ ì €ì¥í–ˆì–´)", false);
      }else{
        setStatus("ì—…ë¡œë“œ ì™„ë£Œ! ğŸ’–");
      }

      $("file").value = "";
      $("caption").value = "";
      // ë‚ ì§œëŠ” ìœ ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ì§€ìš°ì§€ ì•Šê¸°
      // $("postDate").value = "";
      await listPhotos();
    }

    async function adminDelete(id, path){
      if(!IS_ADMIN_PAGE){
        alert("ìš´ì˜ì§„ í˜ì´ì§€ì—ì„œë§Œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”!");
        return false;
      }

      const token = $("adminToken").value.trim();
      if(!token){ alert("ìš´ì˜ì§„ í† í°ì„ ì…ë ¥í•´ì•¼ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”!"); return false; }
      if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return false;

      setStatus("ì‚­ì œ ì¤‘...");

      if(!id || !path){
        setStatus("ì‚­ì œ ì‹¤íŒ¨: id ë˜ëŠ” pathê°€ ë¹„ì–´ìˆì–´ìš”.", true);
        console.error("missing dataset", { id, path });
        return false;
      }

      try{
        const res = await fetch("/.netlify/functions/admin_delete", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ token, id, path }),
        });

        const text = await res.text();
        let data = {};
        try{ data = JSON.parse(text); }catch(e){ data = { raw: text }; }

        if(!res.ok){
          const dbg = data && data.debug ? ` / debug: ${JSON.stringify(data.debug)}` : "";
          setStatus("ì‚­ì œ ì‹¤íŒ¨: " + (data.error || res.statusText) + dbg, true);
          console.error("admin_delete failed", { status: res.status, statusText: res.statusText, data });
          return false;
        }

        setStatus(`ì‚­ì œ ì™„ë£Œ âœ… (DB:${data.db_deleted} / íŒŒì¼:${data.storage_removed||0})`);
        await listPhotos();
        return true;
      }catch(err){
        setStatus("ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨: " + (err?.message || String(err)), true);
        console.error(err);
        return false;
      }
    }

    // âœ… ëª¨ë‹¬ ì‚­ì œ ë²„íŠ¼
    $("modalDeleteBtn").addEventListener("click", async ()=>{
      const ok = await adminDelete(currentModal.id, currentModal.path);
      if(ok) closeModal();
    });

    document.addEventListener("click", async (e)=>{
      const btn = e.target.closest("[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;

      if(action === "copy"){
        try{ await navigator.clipboard.writeText(btn.dataset.url); setStatus("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´!"); }
        catch{ setStatus("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ)", true); }
        return;
      }

      if(action === "open"){
        window.open(btn.dataset.url, "_blank", "noopener");
        return;
      }

      if(action === "view"){
        openModal({
          id: btn.dataset.id,
          path: btn.dataset.path,
          url: btn.dataset.url,
          title: btn.dataset.title || "ì‚¬ì§„",
          nickname: btn.dataset.nickname || "ìµëª…",
          desc: btn.dataset.desc || "",
          dateText: btn.dataset.date || ""
        });
        return;
      }

      if(action === "delete"){
        const ok = await adminDelete(btn.dataset.id, btn.dataset.path);
        if(ok){ btn.closest(".card")?.remove(); }
        return;
      }
    });

    // ì¸ë„¤ì¼ì— í‚¤ë³´ë“œ Enterë¡œ ì—´ê¸°
    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Enter") return;
      const active = document.activeElement;
      if(active && active.matches('.thumb[data-action="view"]')){
        active.click();
      }
    });

    $("uploadBtn").addEventListener("click", upload);
    $("refreshBtn").addEventListener("click", listPhotos);

    // ì²« ë¡œë“œ
    listPhotos();
  </script>
</body>
</html>
