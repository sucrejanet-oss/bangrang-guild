<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ë‘ ê¸¸ë“œ - ì‚¬ì§„ ê²Œì‹œíŒ</title>
  <style>
    :root{--bg:#fff7fb;--card:#ffffff;--line:rgba(0,0,0,.08);--text:#1f1f24;--sub:rgba(31,31,36,.7);--brand:#f48fb1;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:radial-gradient(1000px 500px at 10% 0%, rgba(244,143,177,.22), transparent 60%),radial-gradient(900px 500px at 90% 10%, rgba(179,157,219,.18), transparent 60%),var(--bg);color:var(--text)}
    header{max-width:1100px;margin:0 auto;padding:28px 18px 10px}
    h1{margin:0;font-size:22px}
    p{margin:8px 0 0;color:var(--sub)}
    main{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid rgba(244,143,177,.35);background:rgba(244,143,177,.12);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn:hover{background:rgba(244,143,177,.18)}
    .btn.secondary{border-color:rgba(0,0,0,.12);background:rgba(255,255,255,.65)}
    .field{display:grid;gap:6px;margin-top:10px}
    label{font-size:12px;color:var(--sub)}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.85);font:inherit}
    .thumb{width:100%;aspect-ratio:1/1;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:linear-gradient(135deg, rgba(244,143,177,.12), rgba(179,157,219,.10))}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{display:flex;justify-content:space-between;gap:10px;margin-top:10px;color:var(--sub);font-size:12px}
    .title{margin:8px 0 0;font-weight:800}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .notice{font-size:13px;color:var(--sub)}
    .danger{color:#c62828}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div>
        <h1>ğŸ“· ë°©ë‘ ê¸¸ë“œ ì‚¬ì§„ ê²Œì‹œíŒ</h1>
        <p>ë¡œê·¸ì¸ ì—†ì´ ì—…ë¡œë“œ ê°€ëŠ¥ Â· ìš´ì˜ì§„ì€ ì‚­ì œ ê°€ëŠ¥</p>
      </div>
      <div class="row">
        <a class="btn secondary" href="/">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
        <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:900;">ì‚¬ì§„ ì˜¬ë¦¬ê¸°</div>
          <div class="notice">â€» ìš•ì„¤/í˜ì˜¤/ê°œì¸ì •ë³´ í¬í•¨ ì´ë¯¸ì§€ëŠ” ìš´ì˜ì§„ì´ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.</div>
        </div>
        <div id="status" class="notice"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div style="flex:1;min-width:200px" class="field">
          <label>ë‹‰ë„¤ì„</label>
          <input id="nickname" placeholder="ì˜ˆ: ë„ˆí¬ì§‘ë§‰ë‚´" maxlength="30" />
        </div>
        <div style="flex:2;min-width:240px" class="field">
          <label>ì„¤ëª…(ì„ íƒ)</label>
          <input id="caption" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ë ˆì´ë“œ ì²« í´ë¦¬ì–´!" maxlength="120" />
        </div>
        <div style="min-width:220px" class="field">
          <label>ì‚¬ì§„ íŒŒì¼</label>
          <input id="file" type="file" accept="image/*" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn" id="uploadBtn">ì—…ë¡œë“œ</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:16px 0">

      <div class="row" style="justify-content:space-between">
        <div style="font-weight:900;">ìµœê·¼ ì‚¬ì§„</div>
        <div class="notice">ì´ <span id="count">0</span>ê°œ</div>
      </div>
      <div id="list" class="grid" style="margin-top:12px"></div>

      <div style="margin-top:16px" class="notice">
        <details>
          <summary style="cursor:pointer;font-weight:800">ìš´ì˜ì§„ ì‚­ì œ(ê´€ë¦¬ì)</summary>
          <div style="margin-top:10px" class="field">
            <label>ê´€ë¦¬ì í† í° (ìš´ì˜ì§„ë§Œ ì•Œê³  ìˆëŠ” ê°’)</label>
            <input id="adminToken" placeholder="ADMIN_TOKEN" />
            <div class="notice">ì‚­ì œ ë²„íŠ¼ì´ ë³´ì¼ ë•Œë§Œ ì‚¬ìš©í•´ë„ ë¼ìš”. í† í°ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì§€ ì•Šì•„ìš”.</div>
          </div>
        </details>
      </div>
    </section>
  </main>

  <!-- Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ë„ˆê°€ ë§Œë“  ì„¤ì • íŒŒì¼(ë£¨íŠ¸ì— ìˆì–´ì•¼ í•¨): /supabase_config.js -->
  <script src="/supabase_config.js"></script>

  <script>
    // âœ… "supabase"ë¼ëŠ” ë³€ìˆ˜ëª… ìì²´ë¥¼ ì•ˆ ì”€(ì¤‘ë³µ ì„ ì–¸ ì—ëŸ¬ ë°©ì§€)
    const BUCKET = "bangrang-photos";
    const TABLE  = "photo_posts";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");

    function setStatus(msg, isError=false){
      statusEl.textContent = msg || "";
      statusEl.className = "notice" + (isError ? " danger" : "");
    }
    function fmt(dt){
      try{
        const d = new Date(dt);
        return d.toLocaleString("ko-KR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch(e){ return ""; }
    }
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    // ---- ì„¤ì • íŒŒì¼ ì²´í¬ ----
    if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
      setStatus("ì„¤ì • ëˆ„ë½: supabase_config.jsì— SUPABASE_URL / SUPABASE_ANON_KEYë¥¼ ë„£ì–´ì¤˜!", true);
      console.error("Missing SUPABASE config", window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    }

    // ---- í´ë¼ì´ì–¸íŠ¸ ìƒì„± (sb) ----
    const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    async function listPhotos(){
      setStatus("");
      $("list").innerHTML = "";

      const { data, error } = await sb
        .from(TABLE)
        .select("*")
        .order("created_at", { ascending:false })
        .limit(30);

      if(error){
        setStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message, true);
        return;
      }

      $("count").textContent = data.length;

      if(data.length === 0){
        $("list").innerHTML = '<div class="notice">ì•„ì§ ì‚¬ì§„ì´ ì—†ì–´ìš”! ì²« ì—…ë¡œë“œ í•´ì¤˜ìš” ğŸ’–</div>';
        return;
      }

      for(const row of data){
        const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(row.image_path);
        const imgUrl = pub.publicUrl;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="thumb"><img alt="" src="${imgUrl}"></div>
          <div class="meta"><span>${escapeHtml(row.nickname || "ìµëª…")}</span><span>${fmt(row.created_at)}</span></div>
          <div class="title">${escapeHtml(row.caption || "ì‚¬ì§„")}</div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn secondary" data-action="copy" data-url="${imgUrl}">ë§í¬ ë³µì‚¬</button>
            <button class="btn secondary" data-action="open" data-url="${imgUrl}">ì›ë³¸ ë³´ê¸°</button>
            <button class="btn secondary" data-action="delete" data-id="${row.id}" data-path="${row.image_path}">ì‚­ì œ(ìš´ì˜ì§„)</button>
          </div>
        `;
        $("list").appendChild(card);
      }
    }

    async function upload(){
      const nickname = $("nickname").value.trim() || "ìµëª…";
      const caption  = $("caption").value.trim() || "ì‚¬ì§„";
      const file     = $("file").files?.[0];

      if(!file){ setStatus("ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•´ì¤˜!", true); return; }
      if(file.size > 8 * 1024 * 1024){ setStatus("íŒŒì¼ì´ ë„ˆë¬´ ì»¤ìš”. 8MB ì´í•˜ë¡œ ì˜¬ë ¤ì¤˜!", true); return; }

      setStatus("ì—…ë¡œë“œ ì¤‘...");

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const safeExt = ["jpg","jpeg","png","webp","gif"].includes(ext) ? ext : "jpg";
      const path = `${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;

      const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, {
        cacheControl: "3600",
        upsert: false,
        contentType: file.type || "image/jpeg",
      });
      if(upErr){ setStatus("ì—…ë¡œë“œ ì‹¤íŒ¨: " + upErr.message, true); return; }

      const { error: dbErr } = await sb.from(TABLE).insert([{ nickname, caption, image_path: path }]);
      if(dbErr){
        await sb.storage.from(BUCKET).remove([path]);
        setStatus("ì €ì¥ ì‹¤íŒ¨: " + dbErr.message, true);
        return;
      }

      setStatus("ì—…ë¡œë“œ ì™„ë£Œ! ğŸ’–");
      $("file").value = "";
      $("caption").value = "";
      await listPhotos();
    }

    async function adminDelete(id, path){
      // âœ… ì¤‘ìš”: datasetìœ¼ë¡œ ë°›ì€ idëŠ” ë¬¸ìì—´ì¼ ìˆ˜ ìˆì–´ì„œ ìˆ«ìë¡œ ë³€í™˜
      // (DB idê°€ ìˆ«ìì¼ ë•Œ ì‚­ì œ 0ê±´ ë˜ëŠ” ë¬¸ì œ ë°©ì§€)
      id = Number(id);

      const token = $("adminToken").value.trim();
      if(!token){ alert("ìš´ì˜ì§„ í† í°ì„ ì…ë ¥í•´ì•¼ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”!"); return false; }
      if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return false;

      setStatus("ì‚­ì œ ì¤‘...");
      try{
        const res = await fetch("/.netlify/functions/admin_delete", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ token, id, path }),
        });

        const text = await res.text();
        let data = {};
        try{ data = JSON.parse(text); }catch(e){ data = { raw: text }; }

        if(!res.ok){
          setStatus("ì‚­ì œ ì‹¤íŒ¨: " + (data.error || res.statusText), true);
          console.error("admin_delete failed", { status: res.status, statusText: res.statusText, data });
          return false;
        }

        // ì„±ê³µì¸ë° ì‹¤ì œ ì‚­ì œê°€ 0ê±´ì´ë©´ ì‚¬ìš©ìì—ê²Œ ì•Œë ¤ì¤Œ
        if(data && data.db_deleted === 0){
          setStatus("ì‚­ì œ ìš”ì²­ì€ ì„±ê³µí–ˆì§€ë§Œ, ê¸€ì„ ëª» ì°¾ì•˜ì–´(ì‚­ì œ 0ê±´). ê¸€ ë²ˆí˜¸(id)ê°€ ì˜ëª» ë„˜ì–´ê°„ ê²ƒ ê°™ì•„!", true);
          console.warn("admin_delete ok but db_deleted=0", data);
          await listPhotos();
          return false;
        }

        setStatus(`ì‚­ì œ ì™„ë£Œ âœ… (DB:${data.db_deleted} / íŒŒì¼:${data.storage_removed||0})`);
        await listPhotos();
        return true;
      }catch(err){
        setStatus("ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/í•¨ìˆ˜ ë¬¸ì œ): " + (err?.message || String(err)), true);
        console.error("admin_delete fetch error", err);
        return false;
      }
    }

    document.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;

      if(action === "copy"){
        try{ await navigator.clipboard.writeText(btn.dataset.url); setStatus("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´!"); }
        catch{ setStatus("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ)", true); }
      }
      if(action === "open"){
        window.open(btn.dataset.url, "_blank", "noopener");
      }
      if(action === "delete"){
        const id = Number(btn.dataset.id); // âœ… ì—¬ê¸°ì„œë„ í•œ ë²ˆ ë” ì•ˆì „í•˜ê²Œ ìˆ«ìë¡œ ë³€í™˜
        const ok = await adminDelete(id, btn.dataset.path);
        if(ok){ btn.closest(".card")?.remove(); }
      }
    });

    $("uploadBtn").addEventListener("click", upload);
    $("refreshBtn").addEventListener("click", listPhotos);

    // ì²« ë¡œë“œ
    listPhotos();
  </script>
</body>
</html>
