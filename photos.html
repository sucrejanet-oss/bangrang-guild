<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°©ë‘ ê¸¸ë“œ - ì‚¬ì§„ ê²Œì‹œíŒ</title>

  <!-- Pretendard -->
  <link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.css" />

  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --line:rgba(0,0,0,.09);
      --text:#1f1f24;
      --sub:rgba(31,31,36,.65);
      --brand:#f48fb1;
      --brand2:#b39ddb;
      --error:#e53935;
      --ok:#2e7d32;
      --shadow: 0 14px 38px rgba(0,0,0,.07);
      --shadow2: 0 30px 70px rgba(0,0,0,.25);
      --h:48px;
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Pretendard Variable, Pretendard, system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      background:
        radial-gradient(1100px 520px at 10% 0%, rgba(244,143,177,.23), transparent 60%),
        radial-gradient(1000px 520px at 90% 10%, rgba(179,157,219,.20), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{max-width:1120px;margin:0 auto;padding:30px 18px 10px}
    h1{margin:0;font-size:22px;letter-spacing:-0.2px}
    p{margin:10px 0 0;color:var(--sub)}
    main{max-width:1120px;margin:0 auto;padding:18px 18px 36px}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.99));
      border:1px solid var(--line);
      border-radius:20px;
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .notice{font-size:13px;color:var(--sub)}
    .danger{color:var(--error)}
    hr{border:none;border-top:1px solid rgba(0,0,0,.08);margin:16px 0}

    .btn{
      appearance:none;
      border:1px solid rgba(244,143,177,.35);
      background:rgba(244,143,177,.14);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      transition: transform .06s ease, background .15s ease, border-color .15s ease, color .15s ease, opacity .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(244,143,177,.25);border-color:rgba(244,143,177,.55)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{border-color:rgba(0,0,0,.12);background:rgba(255,255,255,.80)}
    .btn.secondary:hover{background:rgba(244,143,177,.12);color:var(--brand);border-color:rgba(244,143,177,.40)}
    .btn:disabled{opacity:.65;cursor:not-allowed;transform:none}

    /* ë©”ì¸ìœ¼ë¡œ íŒŒë€ ê¸€ì”¨ ë°©ì§€ */
    a.btnlink, a.btnlink:visited, a.btnlink:hover, a.btnlink:active{
      text-decoration:none;
      color:var(--text);
    }
    a.btnlink:hover{ color: var(--brand); }

    /* === í¼ === */
    .form-grid{
      display:grid;
      grid-template-columns:1.25fr 1fr 1.45fr 1fr 1.2fr;
      gap:14px;
      margin-top:14px;
      align-items:end;
    }
    @media (max-width:980px){.form-grid{grid-template-columns:1fr 1fr}}
    @media (max-width:560px){.form-grid{grid-template-columns:1fr}}

    .field{position:relative}
    .field input{
      width:100%;
      height:var(--h);
      padding:14px 14px 0;
      border-radius:var(--r);
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      font-size:14px;
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    /* file/date ë†’ì´ í†µì¼ ë³´ì • */
    .field input[type="file"]{padding:10px 12px 0;height:var(--h)}
    .field input[type="date"]{padding:14px 14px 0;height:var(--h)}
    /* file inputì€ placeholder-shownì´ ì•ˆ ë¨¹ì–´ì„œ ë³„ë„ ì²˜ë¦¬ */
    .field.file label{ top:6px; font-size:11px; }

    /* Floating label */
    .field label{
      position:absolute;
      left:14px;
      top:50%;
      transform:translateY(-50%);
      font-size:13px;
      color:var(--sub);
      pointer-events:none;
      transition:.15s;
      background: rgba(255,255,255,.92);
      padding:0 4px;
      border-radius:8px;
    }
    .field input:focus{
      border-color: rgba(244,143,177,.75);
      box-shadow: 0 0 0 4px rgba(244,143,177,.16);
      background:#fff;
    }
    .field input:focus + label,
    .field input:not(:placeholder-shown) + label{
      top:6px;
      font-size:11px;
      color:var(--brand);
    }

    /* Error / success states */
    .field.error input{
      border-color: rgba(229,57,53,.85);
      box-shadow: 0 0 0 4px rgba(229,57,53,.14);
    }
    .field.error label{color:var(--error)}
    .field .hint{
      margin-top:6px;
      font-size:12px;
      color:var(--sub);
      padding-left:2px;
      min-height:16px;
    }
    .field.error .hint{color:var(--error)}

    .field.success::after{
      content:"âœ“";
      position:absolute;
      right:12px;
      top:12px;
      width:26px;height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(46,125,50,.12);
      color: var(--ok);
      border: 1px solid rgba(46,125,50,.25);
      transform: scale(.7);
      opacity:0;
      animation: pop .75s ease forwards;
      pointer-events:none;
    }
    @keyframes pop{
      0%{transform:scale(.7);opacity:0}
      55%{transform:scale(1.08);opacity:1}
      100%{transform:scale(1);opacity:1}
    }

    /* Preview */
    .filewrap{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
    @media (max-width:980px){.filewrap{grid-template-columns:1fr}}
    .preview{
      width:var(--h);
      height:var(--h);
      border-radius:14px;
      border:1px solid var(--line);
      background: linear-gradient(135deg, rgba(244,143,177,.12), rgba(179,157,219,.10));
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(31,31,36,.55);
      font-size:12px;
    }
    .preview img{width:100%;height:100%;object-fit:cover;display:block}

    /* Grid list */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}

    .post{
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.98));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.06);
    }
    .thumb{
      width:100%;
      aspect-ratio:1/1;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      cursor: zoom-in;
      background: linear-gradient(135deg, rgba(244,143,177,.12), rgba(179,157,219,.10));
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{display:flex;justify-content:space-between;font-size:12px;color:var(--sub);margin-top:10px}
    .title{font-weight:900;margin-top:8px;letter-spacing:-0.2px}
    .desc{margin-top:6px;font-size:13px;color:rgba(31,31,36,.72);line-height:1.35}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(15, 12, 18, .58);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modal-wrap{position:relative; width:min(1120px, 100%);}
    .xbtn{
      position:absolute;
      top: 10px; right: 10px;
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      transition: background .15s ease, transform .06s ease;
      backdrop-filter: blur(6px);
      z-index: 2;
    }
    .xbtn:hover{ background: rgba(244,143,177,.25); }
    .xbtn:active{ transform: translateY(1px); }

    .modal{
      width:100%;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(255,255,255,.28);
      border-radius: 24px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.65fr 1fr;
    }
    @media (max-width:860px){
      .modal{ grid-template-columns: 1fr; }
    }
    .modal-media{
      background: linear-gradient(135deg, rgba(244,143,177,.12), rgba(179,157,219,.10));
      display:flex; align-items:center; justify-content:center;
      padding: 14px;
    }
    .modal-media img{
      width: 100%;
      height: auto;
      max-height: 82vh;
      object-fit: contain;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.12);
      background: white;
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
    }
    @media (max-width:860px){
      .modal-media img{ max-height: 76vh; }
    }
    .modal-side{
      padding: 18px 18px 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .modal-title{ font-weight: 900; font-size: 18px; margin: 0; }
    .modal-meta{ font-size: 13px; color: var(--sub); display:flex; gap:10px; flex-wrap:wrap; }
    .modal-desc{ font-size: 14px; color: rgba(31,31,36,.78); line-height: 1.45; margin: 0; white-space: pre-wrap; }
    .modal-actions{ margin-top:auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    /* Spinner */
    .spinner{
      width:16px;height:16px;
      border-radius:999px;
      border:2px solid rgba(31,31,36,.25);
      border-top-color: rgba(31,31,36,.75);
      animation: spin 0.75s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div>
        <h1>ğŸ“· ë°©ë‘ ê¸¸ë“œ ì‚¬ì§„ ê²Œì‹œíŒ</h1>
        <p>ë°©ë‘ì˜ ì´ë¦„ìœ¼ë¡œ í•¨ê»˜ ê±¸ì–´ì˜¨ ì‹œê°„, ë°©ë‘ì˜ ì¶”ì–µì€ êº¼ì§€ì§€ ì•ŠëŠ”ë‹¤ â›µâœ¨</p>
      </div>
      <div class="row">
        <a class="btn secondary btnlink" href="/">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
        <button class="btn" id="refreshBtn" type="button">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:900;">ì‚¬ì§„ ì˜¬ë¦¬ê¸°</div>
          <div class="notice">â€» ë‹‰ë„¤ì„ì€ ë³¸ìº ë‹‰ë„¤ì„ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš” ! ë¡œê·¸ì¸ì—†ì´ ì—…ë¡œë“œê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
          <div class="notice">â€» ìš•ì„¤/í˜ì˜¤/ê°œì¸ì •ë³´ í¬í•¨ ì´ë¯¸ì§€ëŠ” ìš´ì˜ì§„ì´ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.</div>
          <div class="notice">â€» ë‹¤ë¥¸ ë¶„ë“¤ë„ í•¨ê»˜ êµ¬ê²½í•˜ë©´ì„œ ì¦ê¸¸ìˆ˜ ìˆë„ë¡ ê°„ë‹¨í•œ ì„¤ëª…(ìƒí™©/ì¥ì†Œ ë“±)ì„ ì¶”ê°€í•´ì£¼ì‹œë©´ ì¢‹ì•„ìš” ğŸ˜Š</div>
          <div class="notice">ê²Œì„ì—ì„œ ì‹œì‘ëœ ì¸ì—°ì´ ì–´ëŠìƒˆ ë§ˆìŒ ì† ê°€ê¹Œìš´ ìë¦¬ë¡œ..í•¨ê»˜ì—¬ì„œ í–‰ë³µí–ˆë˜ ìš°ë¦¬âœ¨ì˜¤ëŠ˜ë„ ë°©ë‘ ì¤‘ â›µ</div>
        </div>
        <div id="status" class="notice"></div>
      </div>

      <!-- ì…ë ¥ ìˆœì„œ: ì œëª© / ë‹‰ë„¤ì„ / ì„¤ëª… / ë‚ ì§œ / ì‚¬ì§„íŒŒì¼ -->
      <div class="form-grid" style="margin-top:14px">
        <div class="field" id="fTitle">
          <input id="title" placeholder=" " maxlength="80" />
          <label>ì œëª©</label>
          <div class="hint" id="hTitle"></div>
        </div>

        <div class="field" id="fNick">
          <input id="nickname" placeholder=" " maxlength="30" />
          <label>ë‹‰ë„¤ì„</label>
          <div class="hint" id="hNick"></div>
        </div>

        <div class="field" id="fDesc">
          <input id="caption" placeholder=" " maxlength="400" />
          <label>ì„¤ëª…(ì„ íƒ)</label>
          <div class="hint" id="hDesc"></div>
        </div>

        <div class="field" id="fDate">
          <input id="postDate" type="date" lang="en-US" placeholder=" " />
          <label>ë‚ ì§œ (YY/MM/DD)</label>
          <div class="hint" id="hDate"></div>
        </div>

        <div class="filewrap">
          <div class="field file" id="fFile">
            <input id="file" type="file" accept="image/*" />
            <label>ì‚¬ì§„ íŒŒì¼</label>
            <div class="hint" id="hFile"></div>
          </div>
          <div class="preview" id="previewBox" title="ë¯¸ë¦¬ë³´ê¸°">
            <span id="previewHint">ë¯¸ë¦¬ë³´ê¸°</span>
            <img id="previewImg" alt="" style="display:none" />
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:14px;justify-content:flex-end">
        <button class="btn" id="uploadBtn" type="button">ì—…ë¡œë“œ</button>
      </div>

      <hr>

      <div class="row" style="justify-content:space-between">
        <div style="font-weight:900;">ìµœê·¼ ì‚¬ì§„</div>
        <div class="notice">ì´ <span id="count">0</span>ê°œ</div>
      </div>
      <div id="list" class="grid"></div>

      <!-- ìš´ì˜ì§„ UIëŠ” ìš´ì˜ì§„ í˜ì´ì§€ì—ì„œë§Œ ë³´ì´ë„ë¡ -->
      <div id="adminPanel" style="display:none;margin-top:16px" class="notice">
        <details open>
          <summary style="cursor:pointer;font-weight:900">ìš´ì˜ì§„ ì‚­ì œ(ê´€ë¦¬ì)</summary>
          <div style="margin-top:10px" class="field" id="fAdminTok">
            <input id="adminToken" placeholder=" " />
            <label>ê´€ë¦¬ì í† í°</label>
            <div class="hint">ìš´ì˜ì§„ í˜ì´ì§€ì—ì„œë§Œ ì‚­ì œ ë²„íŠ¼ì´ ë³´ì—¬ìš”. í† í°ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì§€ ì•Šì•„ìš”.</div>
          </div>
        </details>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal-wrap">
      <button class="xbtn" id="modalCloseBtn" type="button">âœ•</button>
      <div class="modal" role="dialog" aria-modal="true" aria-label="ì‚¬ì§„ í¬ê²Œ ë³´ê¸°">
        <div class="modal-media"><img id="modalImg" alt=""></div>
        <div class="modal-side">
          <h2 class="modal-title" id="modalTitle"></h2>
          <div class="modal-meta" id="modalMeta"></div>
          <p class="modal-desc" id="modalDesc"></p>
          <div class="modal-actions">
            <button class="btn secondary" type="button" id="modalCopyBtn">ë§í¬ ë³µì‚¬</button>
            <button class="btn secondary" type="button" id="modalOpenBtn">ì›ë³¸ ë³´ê¸°</button>
            <button class="btn secondary" type="button" id="modalDeleteBtn" style="display:none">ì‚­ì œ(ìš´ì˜ì§„)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/supabase_config.js"></script>

  <script>
    const BUCKET = "bangrang-photos";
    const TABLE  = "photo_posts";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");

    function setStatus(msg, isError=false){
      statusEl.textContent = msg || "";
      statusEl.className = "notice" + (isError ? " danger" : "");
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    // yy/mm/dd í‘œì‹œìš© (list, modal)
    function fmtYYMMDD(ymd){
      if(!ymd) return "";
      const parts = String(ymd).split("-"); // YYYY-MM-DD
      if(parts.length !== 3) return ymd;
      const yy = parts[0].slice(-2);
      const mm = parts[1].padStart(2,"0");
      const dd = parts[2].padStart(2,"0");
      return `${yy}/${mm}/${dd}`;
    }

    function fmtCreatedAt(dt){
      try{
        const d = new Date(dt);
        const yy = String(d.getFullYear()).slice(-2);
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${yy}/${mm}/${dd} ${hh}:${mi}`;
      }catch(e){ return ""; }
    }

    // ìš´ì˜ì§„ í˜ì´ì§€ íŒë³„
    const qs = new URLSearchParams(location.search);
    const IS_ADMIN_PAGE = (qs.get("admin") === "1") || location.pathname.includes("/admin/") || location.pathname.endsWith("/admin") || location.pathname.includes("admin");
    if (IS_ADMIN_PAGE) $("adminPanel").style.display = "block";

    if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
      setStatus("ì„¤ì • ëˆ„ë½: supabase_config.jsì— SUPABASE_URL / SUPABASE_ANON_KEYë¥¼ ë„£ì–´ì¤˜!", true);
      console.error("Missing Supabase config");
    }

    const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    function clearFieldState(){
      ["fTitle","fNick","fDesc","fDate","fFile","fAdminTok"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.classList.remove("error","success");
      });
      ["hTitle","hNick","hDesc","hDate","hFile"].forEach(id=>{
        const h = $(id);
        if(h) h.textContent = "";
      });
    }

    function setError(fieldId, hintId, msg){
      const f = $(fieldId);
      if(f) f.classList.add("error");
      const h = $(hintId);
      if(h) h.textContent = msg || "";
    }

    function pulseSuccess(fieldId){
      const f = $(fieldId);
      if(!f) return;
      f.classList.remove("success");
      void f.offsetWidth; // reflow
      f.classList.add("success");
      setTimeout(()=>f.classList.remove("success"), 1300);
    }

    function setLoading(isLoading){
      const btn = $("uploadBtn");
      if(!btn) return;
      btn.disabled = !!isLoading;
      if(isLoading){
        btn.dataset.orig = btn.textContent;
        btn.innerHTML = `<span class="spinner" aria-hidden="true"></span> ì—…ë¡œë“œ ì¤‘...`;
      }else{
        btn.textContent = btn.dataset.orig || "ì—…ë¡œë“œ";
        btn.dataset.orig = "";
      }
    }

    // Preview
    $("file").addEventListener("change", ()=>{
      const file = $("file").files?.[0];
      const img = $("previewImg");
      const hint = $("previewHint");
      if(!file){
        img.style.display = "none";
        img.src = "";
        hint.style.display = "block";
        return;
      }
      const url = URL.createObjectURL(file);
      img.src = url;
      img.style.display = "block";
      hint.style.display = "none";
    });

    function getStoragePathFromRow(row){
      return row.image_path || row.path || row.imagePath || row.image || row.file_path || "";
    }
    function getTitleFromRow(row){
      return row.title || row.post_title || row.name || row.caption_title || row.caption || "ì‚¬ì§„";
    }
    function getDescFromRow(row){
      return row.description || row.desc || row.caption || "";
    }
    function getPostDateFromRow(row){
      return row.post_date || row.date || row.taken_at || row.event_date || row.photo_date || "";
    }
    function getDisplayDate(row){
      const postDate = getPostDateFromRow(row);
      return postDate ? fmtYYMMDD(postDate) : fmtCreatedAt(row.created_at);
    }

    // Modal state
    let currentModal = { id:null, path:null, url:null, title:"", nickname:"", desc:"", dateText:"" };

    function openModal(payload){
      currentModal = payload;
      $("modalImg").src = payload.url || "";
      $("modalTitle").textContent = payload.title || "ì‚¬ì§„";

      const metaBits = [];
      if(payload.nickname) metaBits.push(`ğŸ‘¤ ${payload.nickname}`);
      if(payload.dateText) metaBits.push(`ğŸ“… ${payload.dateText}`);
      $("modalMeta").textContent = metaBits.join(" Â· ");
      $("modalDesc").textContent = payload.desc || "";

      $("modalBackdrop").style.display = "flex";
      $("modalBackdrop").setAttribute("aria-hidden", "false");
      $("modalDeleteBtn").style.display = IS_ADMIN_PAGE ? "inline-flex" : "none";
    }
    function closeModal(){
      $("modalBackdrop").style.display = "none";
      $("modalBackdrop").setAttribute("aria-hidden", "true");
      $("modalImg").src = "";
    }
    $("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("modalBackdrop")) closeModal(); });
    $("modalCloseBtn").addEventListener("click", closeModal);
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    $("modalCopyBtn").addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(currentModal.url || ""); setStatus("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´!"); }
      catch{ setStatus("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ)", true); }
    });
    $("modalOpenBtn").addEventListener("click", ()=>{
      if(currentModal.url) window.open(currentModal.url, "_blank", "noopener");
    });

    async function listPhotos(){
      setStatus("");
      $("list").innerHTML = "";

      const { data, error } = await sb
        .from(TABLE)
        .select("*")
        .order("created_at", { ascending:false })
        .limit(30);

      if(error){
        setStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message, true);
        console.error(error);
        return;
      }

      $("count").textContent = data.length;

      if(data.length === 0){
        $("list").innerHTML = '<div class="notice">ì•„ì§ ì‚¬ì§„ì´ ì—†ì–´ìš”! ì²« ì—…ë¡œë“œ í•´ì¤˜ìš” ğŸ’–</div>';
        return;
      }

      for(const row of data){
        const storagePath = getStoragePathFromRow(row);
        const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(storagePath || "");
        const imgUrl = pub.publicUrl;

        const title = getTitleFromRow(row);
        const desc  = getDescFromRow(row);
        const nickname = row.nickname || "ìµëª…";
        const dateText = getDisplayDate(row);

        const adminDeleteBtnHtml = IS_ADMIN_PAGE
          ? `<button class="btn secondary" type="button" data-action="delete" data-id="${row.id}" data-path="${storagePath}">ì‚­ì œ(ìš´ì˜ì§„)</button>`
          : ``;

        const card = document.createElement("div");
        card.className = "post";
        card.innerHTML = `
          <div class="thumb" role="button" tabindex="0"
               data-action="view"
               data-id="${row.id}"
               data-path="${storagePath}"
               data-url="${imgUrl}"
               data-title="${escapeHtml(title)}"
               data-nickname="${escapeHtml(nickname)}"
               data-desc="${escapeHtml(desc)}"
               data-date="${escapeHtml(dateText)}">
            <img alt="" src="${imgUrl}">
          </div>
          <div class="meta"><span>${escapeHtml(nickname)}</span><span>${escapeHtml(dateText)}</span></div>
          <div class="title">${escapeHtml(title)}</div>
          ${desc ? `<div class="desc">${escapeHtml(desc)}</div>` : ``}
          <div class="row" style="justify-content:flex-end;margin-top:12px">
            <button class="btn secondary" type="button" data-action="copy" data-url="${imgUrl}">ë§í¬ ë³µì‚¬</button>
            <button class="btn secondary" type="button" data-action="open" data-url="${imgUrl}">ì›ë³¸ ë³´ê¸°</button>
            ${adminDeleteBtnHtml}
          </div>
        `;
        $("list").appendChild(card);
      }
    }

    // Safe insert: try columns, fallback to caption concat
    async function insertPostSafe(payload){
      const { error: err1 } = await sb.from(TABLE).insert([payload]);
      if(!err1) return { ok:true };

      const msg = String(err1.message || "");
      const looksLikeColumnIssue = msg.includes("column") || msg.includes("schema") || msg.includes("not found");

      if(looksLikeColumnIssue){
        const fallback = {
          nickname: payload.nickname,
          caption: payload.description ? `[${payload.title}] ${payload.description}` : (payload.title || "ì‚¬ì§„"),
          image_path: payload.image_path,
        };
        const { error: err2 } = await sb.from(TABLE).insert([fallback]);
        if(!err2){
          return { ok:true, fallback:true, warn:"DBì— title/description/post_date ì»¬ëŸ¼ì´ ì—†ì–´ì„œ captionì— í•©ì³ ì €ì¥í–ˆì–´ìš”." };
        }
        return { ok:false, error: err2 };
      }
      return { ok:false, error: err1 };
    }

    async function upload(){
      clearFieldState();

      const title = $("title").value.trim() || "";
      const nickname = $("nickname").value.trim() || "ìµëª…";
      const description = $("caption").value.trim() || "";
      const post_date = $("postDate").value || "";
      const file = $("file").files?.[0];

      // Validation
      let hasErr = false;
      if(!title){ setError("fTitle","hTitle","ì œëª©ì„ ì…ë ¥í•´ì¤˜!"); hasErr = true; }
      if(!file){ setError("fFile","hFile","ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•´ì¤˜!"); hasErr = true; }
      if(file && file.size > 8 * 1024 * 1024){ setError("fFile","hFile","íŒŒì¼ì´ ë„ˆë¬´ ì»¤ìš”. 8MB ì´í•˜ë¡œ ì˜¬ë ¤ì¤˜!"); hasErr = true; }
      if(hasErr){ setStatus("ì…ë ¥ê°’ì„ í™•ì¸í•´ì¤˜!", true); return; }

      setLoading(true);
      setStatus("ì—…ë¡œë“œ ì¤‘...");

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const safeExt = ["jpg","jpeg","png","webp","gif"].includes(ext) ? ext : "jpg";
      const path = `${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;

      const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, {
        cacheControl: "3600",
        upsert: false,
        contentType: file.type || "image/jpeg",
      });

      if(upErr){
        setLoading(false);
        setStatus("ì—…ë¡œë“œ ì‹¤íŒ¨: " + upErr.message, true);
        return;
      }

      const payload = { title, nickname, description, post_date, image_path: path };
      const ins = await insertPostSafe(payload);

      if(!ins.ok){
        await sb.storage.from(BUCKET).remove([path]);
        setLoading(false);
        setStatus("ì €ì¥ ì‹¤íŒ¨: " + (ins.error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), true);
        console.error(ins.error);
        return;
      }

      setLoading(false);
      setStatus(ins.fallback ? "ì—…ë¡œë“œ ì™„ë£Œ! ğŸ’– (ì£¼ì˜: DB ì»¬ëŸ¼ì´ ì—†ì–´ ì„¤ëª…ì— í•©ì³ ì €ì¥í–ˆì–´)" : "ì—…ë¡œë“œ ì™„ë£Œ! ğŸ’–");

      // success animation
      pulseSuccess("fTitle");
      pulseSuccess("fNick");
      pulseSuccess("fDesc");
      pulseSuccess("fDate");
      pulseSuccess("fFile");

      // reset inputs
      $("file").value = "";
      $("caption").value = "";
      $("title").value = "";
      // ë‹‰ë„¤ì„ì€ ìœ ì§€í•˜ëŠ” ê²Œ í¸í•´ì„œ ìœ ì§€ (ì›í•˜ë©´ ë¹„ìš°ê¸°)
      // $("nickname").value = "";
      $("postDate").value = "";

      // reset preview
      $("previewImg").style.display = "none";
      $("previewImg").src = "";
      $("previewHint").style.display = "block";

      await listPhotos();
    }

    async function adminDelete(id, path){
      if(!IS_ADMIN_PAGE){
        alert("ìš´ì˜ì§„ í˜ì´ì§€ì—ì„œë§Œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”!");
        return false;
      }

      const token = $("adminToken").value.trim();
      if(!token){ alert("ìš´ì˜ì§„ í† í°ì„ ì…ë ¥í•´ì•¼ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”!"); return false; }
      if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return false;

      setStatus("ì‚­ì œ ì¤‘...");

      if(!id || !path){
        setStatus("ì‚­ì œ ì‹¤íŒ¨: id ë˜ëŠ” pathê°€ ë¹„ì–´ìˆì–´ìš”.", true);
        return false;
      }

      try{
        const res = await fetch("/.netlify/functions/admin_delete", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ token, id, path }),
        });

        const text = await res.text();
        let data = {};
        try{ data = JSON.parse(text); }catch(e){ data = { raw: text }; }

        if(!res.ok){
          const dbg = data && data.debug ? ` / debug: ${JSON.stringify(data.debug)}` : "";
          setStatus("ì‚­ì œ ì‹¤íŒ¨: " + (data.error || res.statusText) + dbg, true);
          console.error("admin_delete failed", { status: res.status, data });
          return false;
        }

        setStatus(`ì‚­ì œ ì™„ë£Œ âœ… (DB:${data.db_deleted} / íŒŒì¼:${data.storage_removed||0})`);
        await listPhotos();
        return true;
      }catch(err){
        setStatus("ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨: " + (err?.message || String(err)), true);
        console.error(err);
        return false;
      }
    }

    // Modal delete button
    $("modalDeleteBtn").addEventListener("click", async ()=>{
      const ok = await adminDelete(currentModal.id, currentModal.path);
      if(ok) closeModal();
    });

    // Delegated actions
    document.addEventListener("click", async (e)=>{
      const el = e.target.closest("[data-action]");
      if(!el) return;

      const action = el.dataset.action;

      if(action === "copy"){
        try{ await navigator.clipboard.writeText(el.dataset.url); setStatus("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´!"); }
        catch{ setStatus("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ)", true); }
        return;
      }
      if(action === "open"){
        window.open(el.dataset.url, "_blank", "noopener");
        return;
      }
      if(action === "view"){
        openModal({
          id: el.dataset.id,
          path: el.dataset.path,
          url: el.dataset.url,
          title: el.dataset.title || "ì‚¬ì§„",
          nickname: el.dataset.nickname || "ìµëª…",
          desc: el.dataset.desc || "",
          dateText: el.dataset.date || ""
        });
        return;
      }
      if(action === "delete"){
        const ok = await adminDelete(el.dataset.id, el.dataset.path);
        if(ok){ el.closest(".post")?.remove(); }
        return;
      }
    });

    // thumb keyboard
    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Enter") return;
      const active = document.activeElement;
      if(active && active.matches('.thumb[data-action="view"]')) active.click();
    });

    $("uploadBtn").addEventListener("click", upload);
    $("refreshBtn").addEventListener("click", listPhotos);

    // initial
    listPhotos();
  </script>
</body>
</html>
